---
kind: pipeline
type: docker
name: linux

steps:
- name: "fetch data"
  image: python:latest
  commands:
  - bash download_ssi.sh
  - mkdir -p json
  - python3 process-municipalities.py
  - python3 process-rt.py
  - python3 process-time-series.py
- name: deploy
  image: eeacms/rsync
  environment:
    SSH_KEY:
      from_secret: key
  commands:
  - mkdir -p ~/.ssh
  - eval `ssh-agent -s`
  - echo "$SSH_KEY" | ssh-add -
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
  - rsync --delete -ra -e "ssh -p 8000" index.html js json css ci@barzini.svendcs.com:/var/www/corona.svendcs.com/html
  when:
    branch:
    - master
